#!/usr/bin/env ruby

require 'optparse'

do_timer = false

option_parser = OptionParser.new do |opts|
  # Create a switch
  opts.on("-t", "--timer") do
    do_timer = true
  end
end

option_parser.parse!

thread = nil

if do_timer
  thread = Thread.new(Time.now) do |start_time|
    while true
      time = Time.now
      diff = time - start_time
      m = (diff / 60.0).floor
      s = '%06.3f' % (diff % 60)
      print "\r#{m}:#{s}"
      sleep(0.05)
    end
  end
end

output = `mvn clean install -D skipTests 2>&1`
result = $?.success?

unless thread.nil?
  thread.kill
  print "\r"
end

lines = output.lines.map(&:chomp)
output.clear

found = false

lines.each do |line|
  if found
    puts line
  elsif line.start_with?('[ERROR] COMPILATION ERROR :')
    puts line
    found = true
  elsif line.start_with?('[INFO] BUILD SUCCESS')
    puts '[INFO] ------------------------------------------------------------------------'
    puts line
    found = true
  end
end

unless found
  lines.each do |line|
    puts line
  end
end

if result
  message = 'Successful'
else
  message = 'Failed'
end

`growlnotify -n Terminal -a Terminal -s -m "Build #{message}" -t "mvn clean install -D skipTests"`